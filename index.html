<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTS Statistics Viewer - TFS Performance Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .credits {
            background: #f8f9fa;
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            font-size: 0.9em;
            color: #6c757d;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #667eea;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -3px;
        }

        .tab:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: #f8f9ff;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 600;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .log-entry {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .log-entry.warning {
            border-left-color: #ffc107;
            background: #fffbf0;
        }

        .log-entry.critical {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .timestamp {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }

        .players-online {
            background: #28a745;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 5px;
            overflow: hidden;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: 600;
        }

        .slow-indicator {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }

        .slow {
            background: #ffc107;
            color: #000;
        }

        .very-slow {
            background: #dc3545;
            color: white;
        }

        .filter-bar {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-bar input,
        .filter-bar select {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 0.95em;
            flex: 1;
            min-width: 200px;
        }

        .filter-bar input:focus,
        .filter-bar select:focus {
            outline: none;
            border-color: #667eea;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .summary-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-box h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .tabs {
                flex-direction: column;
            }

            .filter-bar {
                flex-direction: column;
            }

            .filter-bar input,
            .filter-bar select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî• OTS Statistics Viewer</h1>
            <p>Performance Monitor for TFS 1.4+ Servers</p>
        </header>

        <div class="credits">
            <strong>OTS Statistics System</strong> by kondra (otclient@otclient.ovh) | 
            Adapted by gesior | Viewer by Mateus
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">üìä Overview</button>
            <button class="tab" onclick="switchTab('dispatcher')">‚ö° Dispatcher</button>
            <button class="tab" onclick="switchTab('lua')">üî∑ Lua Scripts</button>
            <button class="tab" onclick="switchTab('sql')">üíæ SQL Queries</button>
            <button class="tab" onclick="switchTab('slow')">‚ö†Ô∏è Slow Logs</button>
            <button class="tab" onclick="switchTab('help')">‚ùì Como Usar</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="upload-area">
                <h2 style="margin-bottom: 15px;">üìÅ Carregar Logs</h2>
                <p style="margin-bottom: 20px; color: #6c757d;">Selecione os arquivos de log gerados pelo OTS Statistics</p>
                <input type="file" id="dispatcherFile" accept=".log">
                <input type="file" id="luaFile" accept=".log">
                <input type="file" id="sqlFile" accept=".log">
                <input type="file" id="slowFile" accept=".log">
                <label for="dispatcherFile" class="upload-btn">üìÑ dispatcher.log</label>
                <label for="luaFile" class="upload-btn">üìÑ lua.log</label>
                <label for="sqlFile" class="upload-btn">üìÑ sql.log</label>
                <label for="slowFile" class="upload-btn">üìÑ *_slow.log</label>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <h3>CPU Usage</h3>
                    <div class="value" id="cpuUsage">-</div>
                </div>
                <div class="stat-card">
                    <h3>Players Online</h3>
                    <div class="value" id="playersOnline">-</div>
                </div>
                <div class="stat-card">
                    <h3>Total Entries</h3>
                    <div class="value" id="totalEntries">-</div>
                </div>
                <div class="stat-card">
                    <h3>Slow Operations</h3>
                    <div class="value" id="slowOps">-</div>
                </div>
            </div>

            <div id="summarySection"></div>
        </div>

        <!-- Dispatcher Tab -->
        <div id="dispatcher" class="tab-content">
            <div class="filter-bar">
                <input type="text" id="dispatcherFilter" placeholder="üîç Filtrar por descri√ß√£o...">
                <select id="dispatcherSort">
                    <option value="time">Ordenar por Tempo</option>
                    <option value="calls">Ordenar por Chamadas</option>
                    <option value="usage">Ordenar por Uso %</option>
                </select>
            </div>
            <div id="dispatcherContent"></div>
        </div>

        <!-- Lua Tab -->
        <div id="lua" class="tab-content">
            <div class="filter-bar">
                <input type="text" id="luaFilter" placeholder="üîç Filtrar por script...">
                <select id="luaSort">
                    <option value="time">Ordenar por Tempo</option>
                    <option value="calls">Ordenar por Chamadas</option>
                </select>
            </div>
            <div id="luaContent"></div>
        </div>

        <!-- SQL Tab -->
        <div id="sql" class="tab-content">
            <div class="filter-bar">
                <input type="text" id="sqlFilter" placeholder="üîç Filtrar por query...">
                <select id="sqlSort">
                    <option value="time">Ordenar por Tempo</option>
                    <option value="calls">Ordenar por Chamadas</option>
                </select>
            </div>
            <div id="sqlContent"></div>
        </div>

        <!-- Slow Logs Tab -->
        <div id="slow" class="tab-content">
            <div class="filter-bar">
                <input type="text" id="slowFilter" placeholder="üîç Filtrar...">
                <select id="slowType">
                    <option value="all">Todos</option>
                    <option value="slow">Slow (10-50ms)</option>
                    <option value="very_slow">Very Slow (>50ms)</option>
                </select>
            </div>
            <div id="slowContent"></div>
        </div>

        <!-- Help Tab -->
        <div id="help" class="tab-content">
            <div class="summary-box">
                <h3>üìö Como Usar o OTS Statistics</h3>
                <p style="margin-bottom: 15px;">O sistema OTS Statistics rastreia performance do seu servidor TFS em tempo real.</p>

                <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">üìÇ Arquivos Gerados:</h4>
                <ul style="line-height: 2; margin-left: 20px;">
                    <li><strong>dispatcher.log</strong> - Tarefas do thread dispatcher</li>
                    <li><strong>lua.log</strong> - Chamadas de fun√ß√µes Lua</li>
                    <li><strong>sql.log</strong> - Queries do banco de dados</li>
                    <li><strong>dispatcher_slow.log</strong> - Opera√ß√µes lentas (10-50ms)</li>
                    <li><strong>dispatcher_very_slow.log</strong> - Opera√ß√µes muito lentas (>50ms)</li>
                    <li><strong>lua_slow.log / lua_very_slow.log</strong> - Scripts Lua lentos</li>
                    <li><strong>sql_slow.log / sql_very_slow.log</strong> - Queries SQL lentas</li>
                </ul>

                <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">‚öôÔ∏è Configura√ß√£o no config.lua:</h4>
                <div class="code-block">-- OTS Statistics<br>
statsEnabled = true<br>
statsReportInterval = 60000  -- 60 segundos<br>
statsSlowThreshold = 10      -- 10ms = slow<br>
statsVerySlowThreshold = 50  -- 50ms = very slow</div>

                <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">üìä Interpretando os Resultados:</h4>
                <ul style="line-height: 2; margin-left: 20px;">
                    <li><strong>Time (ms)</strong> - Tempo total gasto na opera√ß√£o</li>
                    <li><strong>Calls</strong> - N√∫mero de vezes que foi executada</li>
                    <li><strong>Rel usage %</strong> - % do tempo em rela√ß√£o ao total medido</li>
                    <li><strong>Real usage %</strong> - % real do CPU usage</li>
                </ul>

                <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">üéØ O que Procurar:</h4>
                <ul style="line-height: 2; margin-left: 20px;">
                    <li>‚ùå <strong>CPU Usage > 50%</strong> - Servidor sob carga pesada</li>
                    <li>‚ö†Ô∏è <strong>Opera√ß√µes > 100ms</strong> - Problema grave de performance</li>
                    <li>‚ö†Ô∏è <strong>SQL Queries > 50ms</strong> - Necessita √≠ndices no DB</li>
                    <li>‚ö†Ô∏è <strong>Scripts Lua > 20ms</strong> - Revisar l√≥gica do script</li>
                </ul>

                <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">üîß Rastreamento Customizado:</h4>
                <p>Para adicionar rastreamento personalizado no c√≥digo C++:</p>
                <div class="code-block">void Game::internalDecayItem(Item* item)<br>
{<br>
&nbsp;&nbsp;&nbsp;&nbsp;AutoStat stat("internalDecayItem", std::to_string(item->getID()));<br>
&nbsp;&nbsp;&nbsp;&nbsp;// seu c√≥digo aqui<br>
}</div>

                <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">üí° Dicas:</h4>
                <ul style="line-height: 2; margin-left: 20px;">
                    <li>‚úÖ Monitore logs durante hor√°rios de pico</li>
                    <li>‚úÖ Compare antes/depois de otimiza√ß√µes</li>
                    <li>‚úÖ Use filtros para focar em problemas espec√≠ficos</li>
                    <li>‚úÖ Identifique players que causam lag (usando AutoStat)</li>
                </ul>
            </div>

            <div class="summary-box">
                <h3>üîó Links √öteis</h3>
                <div class="summary-item">
                    <span>Thread Original OTLand</span>
                    <a href="https://otland.net/threads/how-to-read-ots-statistics-logs.283722/" target="_blank">Ver Tutorial</a>
                </div>
                <div class="summary-item">
                    <span>Commit GitHub (gesior)</span>
                    <a href="https://github.com/gesior/forgottenserver-gesior/commit/0ad4be6cab3e335e6f7dc767722f70ee0c849be8" target="_blank">Ver C√≥digo</a>
                </div>
                <div class="summary-item">
                    <span>Autor Original</span>
                    <span>kondra (otclient@otclient.ovh)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let dispatcherData = [];
        let luaData = [];
        let sqlData = [];
        let slowData = [];

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Parse dispatcher.log
        document.getElementById('dispatcherFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseDispatcherLog(content);
                renderDispatcher();
                updateStats();
            };
            reader.readAsText(file);
        });

        // Parse lua.log
        document.getElementById('luaFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseLuaLog(content);
                renderLua();
                updateStats();
            };
            reader.readAsText(file);
        });

        // Parse sql.log
        document.getElementById('sqlFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseSqlLog(content);
                renderSql();
                updateStats();
            };
            reader.readAsText(file);
        });

        // Parse slow logs
        document.getElementById('slowFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                parseSlowLog(content);
                renderSlow();
                updateStats();
            };
            reader.readAsText(file);
        });

        function parseDispatcherLog(content) {
            dispatcherData = [];
            const entries = content.split(/\[\d{2} \w+ \d{4}\]/);

            entries.forEach(entry => {
                if (!entry.trim()) return;

                const lines = entry.split('\n');
                let currentEntry = {
                    timestamp: '',
                    thread: '',
                    cpuUsage: '',
                    idle: '',
                    other: '',
                    playersOnline: 0,
                    tasks: []
                };

                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;

                    if (line.includes('Thread:')) {
                        const match = line.match(/Thread: (\d+) Cpu usage: ([\d.]+)% Idle: ([\d.]+)% Other: ([\d.-]+)% Players online: (\d+)/);
                        if (match) {
                            currentEntry.thread = match[1];
                            currentEntry.cpuUsage = match[2];
                            currentEntry.idle = match[3];
                            currentEntry.other = match[4];
                            currentEntry.playersOnline = parseInt(match[5]);
                        }
                    } else if (line.match(/^\d+/)) {
                        const parts = line.split(/\s+/);
                        if (parts.length >= 4) {
                            currentEntry.tasks.push({
                                time: parseInt(parts[0]),
                                calls: parseInt(parts[1]),
                                relUsage: parseFloat(parts[2].replace('%', '')),
                                realUsage: parseFloat(parts[3].replace('%', '')),
                                description: parts.slice(4).join(' ')
                            });
                        }
                    }
                });

                if (currentEntry.tasks.length > 0) {
                    dispatcherData.push(currentEntry);
                }
            });
        }

        function parseLuaLog(content) {
            luaData = [];
            const entries = content.split(/\[\d{2} \w+ \d{4}\]/);

            entries.forEach(entry => {
                if (!entry.trim()) return;

                const lines = entry.split('\n');
                let currentEntry = { scripts: [] };

                lines.forEach(line => {
                    line = line.trim();
                    if (!line || line.includes('Time (ms)')) return;

                    if (line.match(/^\d+/)) {
                        const parts = line.split(/\s+/);
                        if (parts.length >= 4) {
                            currentEntry.scripts.push({
                                time: parseInt(parts[0]),
                                calls: parseInt(parts[1]),
                                relUsage: parseFloat(parts[2].replace('%', '')),
                                realUsage: parseFloat(parts[3].replace('%', '')),
                                path: parts.slice(4).join(' ')
                            });
                        }
                    }
                });

                if (currentEntry.scripts.length > 0) {
                    luaData.push(currentEntry);
                }
            });
        }

        function parseSqlLog(content) {
            sqlData = [];
            const entries = content.split(/\[\d{2} \w+ \d{4}\]/);

            entries.forEach(entry => {
                if (!entry.trim()) return;

                const lines = entry.split('\n');
                let currentEntry = { queries: [] };

                lines.forEach(line => {
                    line = line.trim();
                    if (!line || line.includes('Time (ms)')) return;

                    if (line.match(/^\d+/)) {
                        const parts = line.split(/\s+/);
                        if (parts.length >= 4) {
                            currentEntry.queries.push({
                                time: parseInt(parts[0]),
                                calls: parseInt(parts[1]),
                                relUsage: parseFloat(parts[2].replace('%', '')),
                                realUsage: parseFloat(parts[3].replace('%', '')),
                                query: parts.slice(4).join(' ')
                            });
                        }
                    }
                });

                if (currentEntry.queries.length > 0) {
                    sqlData.push(currentEntry);
                }
            });
        }

        function parseSlowLog(content) {
            slowData = [];
            const lines = content.split('\n');

            lines.forEach(line => {
                const match = line.match(/\[(\d{2} \w+ \d{4})\] Execution time: (\d+) ms - (.+?) - (.+)/);
                if (match) {
                    slowData.push({
                        timestamp: match[1],
                        time: parseInt(match[2]),
                        type: match[2] >= 50 ? 'very_slow' : 'slow',
                        description: match[3],
                        details: match[4]
                    });
                }
            });
        }

        function renderDispatcher() {
            const content = document.getElementById('dispatcherContent');
            if (dispatcherData.length === 0) {
                content.innerHTML = '<div class="empty-state"><p>Nenhum dado de dispatcher carregado</p></div>';
                return;
            }

            let html = '';
            dispatcherData.forEach((entry, index) => {
                const severity = parseFloat(entry.cpuUsage) > 50 ? 'critical' : parseFloat(entry.cpuUsage) > 20 ? 'warning' : '';

                html += `
                    <div class="log-entry ${severity}">
                        <div class="log-header">
                            <span class="timestamp">Entry #${index + 1}</span>
                            <span class="players-online">üë• ${entry.playersOnline} players</span>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Thread ${entry.thread}</strong> | 
                            CPU: <strong>${entry.cpuUsage}%</strong> | 
                            Idle: <strong>${entry.idle}%</strong> | 
                            Other: <strong>${entry.other}%</strong>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Time (ms)</th>
                                    <th>Calls</th>
                                    <th>Rel Usage</th>
                                    <th>Real Usage</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                entry.tasks.forEach(task => {
                    html += `
                        <tr>
                            <td><strong>${task.time}</strong></td>
                            <td>${task.calls}</td>
                            <td>
                                ${task.relUsage.toFixed(2)}%
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${Math.min(task.relUsage, 100)}%"></div>
                                </div>
                            </td>
                            <td>${task.realUsage.toFixed(5)}%</td>
                            <td><code>${task.description}</code></td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            content.innerHTML = html;
        }

        function renderLua() {
            const content = document.getElementById('luaContent');
            if (luaData.length === 0) {
                content.innerHTML = '<div class="empty-state"><p>Nenhum dado Lua carregado</p></div>';
                return;
            }

            let html = '';
            luaData.forEach((entry, index) => {
                html += `
                    <div class="log-entry">
                        <div class="log-header">
                            <span class="timestamp">Entry #${index + 1}</span>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Time (ms)</th>
                                    <th>Calls</th>
                                    <th>Rel Usage</th>
                                    <th>Real Usage</th>
                                    <th>Script Path</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                entry.scripts.forEach(script => {
                    const scriptName = script.path.split('/').pop();
                    html += `
                        <tr>
                            <td><strong>${script.time}</strong></td>
                            <td>${script.calls}</td>
                            <td>${script.relUsage.toFixed(2)}%</td>
                            <td>${script.realUsage.toFixed(5)}%</td>
                            <td title="${script.path}"><code>${scriptName}</code></td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            content.innerHTML = html;
        }

        function renderSql() {
            const content = document.getElementById('sqlContent');
            if (sqlData.length === 0) {
                content.innerHTML = '<div class="empty-state"><p>Nenhum dado SQL carregado</p></div>';
                return;
            }

            let html = '';
            sqlData.forEach((entry, index) => {
                html += `
                    <div class="log-entry">
                        <div class="log-header">
                            <span class="timestamp">Entry #${index + 1}</span>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Time (ms)</th>
                                    <th>Calls</th>
                                    <th>Rel Usage</th>
                                    <th>Real Usage</th>
                                    <th>Query</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                entry.queries.forEach(query => {
                    const queryPreview = query.query.substring(0, 100) + (query.query.length > 100 ? '...' : '');
                    html += `
                        <tr>
                            <td><strong>${query.time}</strong></td>
                            <td>${query.calls}</td>
                            <td>${query.relUsage.toFixed(2)}%</td>
                            <td>${query.realUsage.toFixed(5)}%</td>
                            <td title="${query.query}"><code>${queryPreview}</code></td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            content.innerHTML = html;
        }

        function renderSlow() {
            const content = document.getElementById('slowContent');
            if (slowData.length === 0) {
                content.innerHTML = '<div class="empty-state"><p>Nenhum log lento carregado</p></div>';
                return;
            }

            let html = '';
            slowData.forEach(entry => {
                const severity = entry.type === 'very_slow' ? 'critical' : 'warning';
                html += `
                    <div class="log-entry ${severity}">
                        <div class="log-header">
                            <span class="timestamp">${entry.timestamp}</span>
                            <span class="slow-indicator ${entry.type.replace('_', '-')}">${entry.time}ms</span>
                        </div>
                        <p><strong>Descri√ß√£o:</strong> <code>${entry.description}</code></p>
                        <p><strong>Detalhes:</strong> <code>${entry.details}</code></p>
                    </div>
                `;
            });

            content.innerHTML = html;
        }

        function updateStats() {
            let totalCpuUsage = 0;
            let totalPlayers = 0;
            let totalEntries = 0;

            if (dispatcherData.length > 0) {
                dispatcherData.forEach(entry => {
                    totalCpuUsage += parseFloat(entry.cpuUsage);
                    totalPlayers = Math.max(totalPlayers, entry.playersOnline);
                });
                const avgCpu = (totalCpuUsage / dispatcherData.length).toFixed(2);
                document.getElementById('cpuUsage').textContent = avgCpu + '%';
                document.getElementById('playersOnline').textContent = totalPlayers;
                totalEntries += dispatcherData.length;
            }

            totalEntries += luaData.length + sqlData.length;
            document.getElementById('totalEntries').textContent = totalEntries;
            document.getElementById('slowOps').textContent = slowData.length;

            // Gerar resumo
            generateSummary();
        }

        function generateSummary() {
            const section = document.getElementById('summarySection');

            let html = '<div class="summary-box"><h3>üìà Resumo da Performance</h3>';

            if (dispatcherData.length > 0) {
                const lastEntry = dispatcherData[dispatcherData.length - 1];
                html += `
                    <div class="summary-item">
                        <span>√öltima CPU Usage</span>
                        <strong style="color: ${parseFloat(lastEntry.cpuUsage) > 50 ? '#dc3545' : '#28a745'}">${lastEntry.cpuUsage}%</strong>
                    </div>
                    <div class="summary-item">
                        <span>Total de Tasks Registradas</span>
                        <strong>${dispatcherData.reduce((acc, e) => acc + e.tasks.length, 0)}</strong>
                    </div>
                `;
            }

            if (luaData.length > 0) {
                const totalLuaScripts = luaData.reduce((acc, e) => acc + e.scripts.length, 0);
                html += `
                    <div class="summary-item">
                        <span>Scripts Lua Executados</span>
                        <strong>${totalLuaScripts}</strong>
                    </div>
                `;
            }

            if (sqlData.length > 0) {
                const totalQueries = sqlData.reduce((acc, e) => acc + e.queries.length, 0);
                html += `
                    <div class="summary-item">
                        <span>Queries SQL Executadas</span>
                        <strong>${totalQueries}</strong>
                    </div>
                `;
            }

            if (slowData.length > 0) {
                const verySlow = slowData.filter(e => e.type === 'very_slow').length;
                const slow = slowData.filter(e => e.type === 'slow').length;
                html += `
                    <div class="summary-item">
                        <span>Opera√ß√µes Lentas</span>
                        <strong style="color: #ffc107">${slow} slow</strong>
                    </div>
                    <div class="summary-item">
                        <span>Opera√ß√µes Muito Lentas</span>
                        <strong style="color: #dc3545">${verySlow} very slow</strong>
                    </div>
                `;
            }

            html += '</div>';
            section.innerHTML = html;
        }

        // Filters
        document.getElementById('dispatcherFilter').addEventListener('input', filterDispatcher);
        document.getElementById('luaFilter').addEventListener('input', filterLua);
        document.getElementById('sqlFilter').addEventListener('input', filterSql);
        document.getElementById('slowFilter').addEventListener('input', filterSlow);

        function filterDispatcher() {
            // Implementar filtro se necess√°rio
            renderDispatcher();
        }

        function filterLua() {
            renderLua();
        }

        function filterSql() {
            renderSql();
        }

        function filterSlow() {
            renderSlow();
        }
    </script>
</body>
</html>